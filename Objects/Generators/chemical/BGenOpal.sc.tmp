
BGenOpal : BGen
{
	var paramValues, reverb, effectBus, <>isPlaying, preControl, <>frequencies, <>waveform, updatedFrequencies;
	*new { |id=0, description, duration=10, control, outBus=0, values, frequencies, waveform=1, load=1|
		^super.newCopyArgs(id, description, duration, control, outBus, nil, values, frequencies, waveform).init(load);
	}

	init {|load=1|

		this.setDescription;
		this.isPlaying = 0;
		preControl = BControl.new;
		if(this.control.isNil, {this.control = BControl.new});

		if(load > 0, {

		this.initEffect.value;
 		updatedFrequencies = Array.new(4);
 		updatedFrequencies.add(67);
 		updatedFrequencies.add(87);
 		updatedFrequencies.add(97);
 		updatedFrequencies.add(107);
		if(frequencies.isNil, {frequencies = [12000, 11000, 10000, 90000]});
		});
	}

	setParam {|paramName, paramValue|
	if(paramName == \duration, {duration = paramValue});
	if(paramName == \frequencies, {frequencies = paramValue});
	if(paramName == \waveform, {waveform = paramValue});
	if(paramName == \outBus, {outBus = paramValue});
	}

	setParamAndUpdate {|param, value|
	if(this.isPlaying > 0,
	{control.setParamValue(param, value);
	this.update.value;})}

	initEffect {
		effectBus = Bus.audio(Server.local, 2);
		reverb = Bwrap.new(\opalVerb, [\in, effectBus, \out, outBus]);
		reverb.play;
	}

	*loadSynthDefs {

		SynthDef(\opalSine,
		{| out=0, amp=0.5, atk=0.5, sus=10, rel=0.1, surface=0.0, speed=0.001, entropy=0.0, randomSpeed=2, repAtk=0.02, repSus=0.02, repRel=2,
		frequencies=#[80, 100, 120, 140], amplitudes=#[0.1, 1.0, 0.4, 0.8]|
	 	var signal, osca, oscb, oscc, oscd, distorted;
	 	var downsamp, samplerate=8000, bitsize=15;
	 	var env = EnvGen.kr(Env.new([0,1,1,0], [atk,sus,rel], -2), doneAction:2);
		osca = SinOsc.ar(frequencies[0], mul:amplitudes[0]) * EnvGen.ar(Env.new([0, 1, 0.2, 0],[repAtk, repSus, repRel]), Impulse.ar((speed * LFNoise1.ar(freq:randomSpeed, add:1,  mul:entropy))));
		oscb = SinOsc.ar(frequencies[1], mul:amplitudes[1]) * EnvGen.ar(Env.new([0, 1, 0.2, 0],[repAtk, repSus, repRel]), Impulse.ar((speed * LFNoise1.ar(freq:randomSpeed, add:1,  mul:entropy))));
		oscc = SinOsc.ar(frequencies[2], mul:amplitudes[2]) * EnvGen.ar(Env.new([0, 1, 0.2, 0],[repAtk, repSus, repRel]), Impulse.ar((speed * LFNoise1.ar(freq:randomSpeed, add:1,  mul:entropy))));
		oscd = SinOsc.ar(frequencies[3], mul:amplitudes[3]) * EnvGen.ar(Env.new([0, 1, 0.2, 0],[repAtk, repSus, repRel]), Impulse.ar((speed * LFNoise1.ar(freq:randomSpeed, add:1,  mul:entropy))));
		signal = (osca + oscb + oscc + oscd) * amp;
		downsamp = Latch.ar(signal, Impulse.ar(samplerate*0.5));
		distorted = downsamp.round(0.5 ** bitsize);
		signal = (signal * (1 - surface)) + (distorted * surface);
		signal = signal * 0.2;
		signal = signal * amp;
		Out.ar(out, signal);
		}).add;

		SynthDef(\opalImpulse,
		{| out=0, amp=0.5, atk=0.5, sus=10, rel=0.1, surface=0.0, speed=0.001, entropy=0.0, randomSpeed=2, repAtk=0.02, repSus=0.02, repRel=2,
		frequencies=#[80, 100, 120, 140], amplitudes=#[0.1, 1.0, 0.4, 0.8]|
	 	var signal, osca, oscb, oscc, oscd, distorted;
	 	var downsamp, samplerate=8000, bitsize=15;
	 	var env = EnvGen.kr(Env.new([0,1,1,0], [atk,sus,rel], -2), doneAction:2);
		osca = Impulse.ar(frequencies[0], mul:amplitudes[0]) * EnvGen.ar(Env.new([0, 1, 0.2, 0],[repAtk, repSus, repRel]), Impulse.ar((speed * LFNoise1.ar(freq:randomSpeed, add:1,  mul:entropy))));
		oscb = Impulse.ar(frequencies[1], mul:amplitudes[1]) * EnvGen.ar(Env.new([0, 1, 0.2, 0],[repAtk, repSus, repRel]), Impulse.ar((speed * LFNoise1.ar(freq:randomSpeed, add:1,  mul:entropy))));
		oscc = Impulse.ar(frequencies[2], mul:amplitudes[2]) * EnvGen.ar(Env.new([0, 1, 0.2, 0],[repAtk, repSus, repRel]), Impulse.ar((speed * LFNoise1.ar(freq:randomSpeed, add:1,  mul:entropy))));
		oscd = Impulse.ar(frequencies[3], mul:amplitudes[3]) * EnvGen.ar(Env.new([0, 1, 0.2, 0],[repAtk, repSus, repRel]), Impulse.ar((speed * LFNoise1.ar(freq:randomSpeed, add:1,  mul:entropy))));
		signal = (osca + oscb + oscc + oscd) * amp;
		downsamp = Latch.ar(signal, Impulse.ar(samplerate*0.5));
		distorted = downsamp.round(0.5 ** bitsize);
		signal = (signal * (1 - surface)) + (distorted * surface);
		signal = signal * 0.2;
		signal = signal * amp;
		Out.ar(out, signal);
		}).add;

		SynthDef(\opalLFTri,
		{| out=0, amp=0.5, atk=0.5, sus=10, rel=0.1, surface=0.0, speed=0.001, entropy=0.0, randomSpeed=2, repAtk=0.02, repSus=0.02, repRel=2,
		frequencies=#[80, 100, 120, 140], amplitudes=#[0.1, 1.0, 0.4, 0.8]|
	 	var signal, osca, oscb, oscc, oscd, distorted;
	 	var downsamp, samplerate=8000, bitsize=15;
	 	var env = EnvGen.kr(Env.new([0,1,1,0], [atk,sus,rel], -2), doneAction:2);
		osca = LFTri.ar(frequencies[0], mul:amplitudes[0]) * EnvGen.ar(Env.new([0, 1, 0.2, 0],[repAtk, repSus, repRel]), LFTri.ar((speed * LFNoise1.ar(freq:randomSpeed, add:1,  mul:entropy))));
		oscb = LFTri.ar(frequencies[1], mul:amplitudes[1]) * EnvGen.ar(Env.new([0, 1, 0.2, 0],[repAtk, repSus, repRel]), LFTri.ar((speed * LFNoise1.ar(freq:randomSpeed, add:1,  mul:entropy))));
		oscc = LFTri.ar(frequencies[2], mul:amplitudes[2]) * EnvGen.ar(Env.new([0, 1, 0.2, 0],[repAtk, repSus, repRel]), LFTri.ar((speed * LFNoise1.ar(freq:randomSpeed, add:1,  mul:entropy))));
		oscd = LFTri.ar(frequencies[3], mul:amplitudes[3]) * EnvGen.ar(Env.new([0, 1, 0.2, 0],[repAtk, repSus, repRel]), LFTri.ar((speed * LFNoise1.ar(freq:randomSpeed, add:1,  mul:entropy))));
		signal = (osca + oscb + oscc + oscd) * amp;
		downsamp = Latch.ar(signal, LFTri.ar(samplerate*0.5));
		distorted = downsamp.round(0.5 ** bitsize);
		signal = (signal * (1 - surface)) + (distorted * surface);
		signal = HPF.ar(signal, 40) + LPF.ar(signal, 18500);
		signal = signal * 0.1;
		signal = signal * amp;
		Out.ar(out, signal);
		}).add;

		SynthDef(\opalVerb,{| 