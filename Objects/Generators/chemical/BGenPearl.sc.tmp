
BGenPearl : BGen
{
	var paramValues, reverb, effectBus, <>isPlaying, preControl, <>frequencies, <>durations, <>amplitudes, updatedFrequencies;

	*new { |id=0, description, duration=10, control, outBus=0, values, frequencies, durations, amplitudes, load=1|
		^super.newCopyArgs(id, description, duration, control, outBus, nil, values, frequencies, durations, amplitudes).init(load);
	}

	init {|load=1|

		this.setDescription;
		this.isPlaying = 0;
		preControl = BControl.new;
		if(this.control.isNil, {this.control = BControl.new});

		if(load > 0, {

		this.initEffect.value;
 		updatedFrequencies = Array.new(4);
 		updatedFrequencies.add(67);
 		updatedFrequencies.add(87);
 		updatedFrequencies.add(97);
 		updatedFrequencies.add(107);
		if(frequencies.isNil, {frequencies = [67, 89, 113, 139]});
		if(durations.isNil, {durations = [0.5, 1, 0.5, 2, 4, 0.5, 1]});
		if(amplitudes.isNil, {amplitudes = [1.0, 0.1, 0.8, 0.2, 0.4, 1.0, 0.1, 1.0]});
		});
	}

	setParam {|paramName, paramValue|
	if(paramName == \duration, {duration = paramValue});
	if(paramName == \frequencies, {frequencies = paramValue});
	if(paramName == \durations, {durations = paramValue});
	if(paramName == \amplitudes, {amplitudes = paramValue});
	if(paramName == \outBus, {outBus = paramValue});
	}

	setParamAndUpdate {|param, value|
	if(this.isPlaying > 0,
	{control.setParamValue(param, value);
	this.update.value;})}

	initEffect {
		effectBus = Bus.audio(Server.local, 2);
		reverb = Bwrap.new(\pearlVerb, [\in, effectBus, \out, outBus]);
		reverb.play;
	}

	*loadSynthDefs {

		SynthDef(\pearl,
		{| out=0, amp=0.5, atk=0.5, sus=10, rel=0.1, surface=0.0, speed=0.001, density=0.5, entropy=0.0, knum=12, lop=10000, hip=10000, newAmp=0.5,
		frequencies=#[80, 100, 120, 140], durations=#[0.5, 1, 0.5, 2, 4, 0.5, 1], amplitudes=#[0.1, 1.0, 0.4, 0.8, 1.0, 0.1, 0.7, 0.0]|
	 	var env = EnvGen.kr(Env.new([0,1,1,0], [atk,sus,rel], -2), doneAction:2);
	 	var randTrigger = Dust.kr(25*speed);
	 	var rand = TRand.kr(1 - entropy, 1 + entropy, randTrigger);
		var signal = Mix.new(Gendy3.ar(freq:frequencies * rand, mul:amp, knum:knum, adparam:surface, ampscale:amp));
		signal = signal + Mix.new(Gendy3.ar(freq:(frequencies * 2) * rand, mul:amp, knum:knum*0.75, adparam:surface*0.5, ampscale:(amp * density)));
	 	signal = (RLPF.ar(signal, lop, 1.15) * (1-surface)) + (RHPF.ar(signal, hip, 1.15) * surface);
	 	signal = signal * EnvGen.kr(Env.new(amplitudes, durations * (rand) * (1-speed)).circle);
	 	signal = Limiter.ar(signal * 1.8, 0.99, 0.05);
		Out.ar(out, signal);
		}, [0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1]
		).add;

		SynthDef(\pearlVerb,{| 